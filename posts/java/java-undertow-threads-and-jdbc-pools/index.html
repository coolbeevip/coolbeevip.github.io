<!doctype html><html lang=en data-theme><head>
<title> Lei Zhang | The Impact of Undertow Thread Options & Database Connection Pool on Performance </title>
<meta charset=utf-8><meta name=generator content="Hugo 0.89.4"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=description content="This is my knowledge base. I document things here">
<link rel=stylesheet href=/css/style.min.7cf3c5090ac13256a5fa5531e5649cfe5a2ba7de88dca14ce0b6e253409a3511.css integrity="sha256-fPPFCQrBMlal+lUx5WSc/lorp96I3KFM4LbiU0CaNRE=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS+yuWSR4=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/css/custom.min.3fa691134fafa8351e9d193939a352647c1ae886828bdefa3f5a272653dbf7e4.css integrity="sha256-P6aRE0+vqDUenRk5OaNSZHwa6IaCi976P1onJlPb9+Q=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous>
<link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png>
<link rel=canonical href=/posts/java/java-undertow-threads-and-jdbc-pools/>
<script type=text/javascript src=/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin=anonymous></script>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="The Impact of Undertow Thread Options & Database Connection Pool on Performance">
<meta name=twitter:description content="Hikari 线程参数和数据库连接池参数对业务吞吐率的影响分析
场景 本例中我们使用 Undertow 作为 Web 容器，使用 Hikari 作为数据库连接池， 并通过 spring.datasource.hikari.maximum-pool-size 和 server.undertow.threads.worker 两个参数的调整，看看对于业务的性能影响有多大
为此我准备了一个简单的 DEMO，并且执行 1000 次请求，并发 100，每次请求执行一个 SLEEP(5) 的 SQL模拟单笔耗时。并在一个 2C 的服务器上测试。应用默认参数如下
spring.datasource.hikari.connection-timeout=30000 spring.datasource.hikari.minimum-idle=10 spring.datasource.hikari.maximum-pool-size=10 server.undertow.threads.worker(默认是 2C*8) 默认参数 $ ab -c 100 -n 1000 http://localhost:6060/test This is ApacheBench, Version 2.3 <$Revision: 1879490 $> Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking localhost (be patient) Completed 100 requests Completed 200 requests Completed 300 requests Completed 400 requests Completed 500 requests Completed 600 requests Completed 700 requests Completed 800 requests Completed 900 requests Completed 1000 requests Finished 1000 requests Server Software: Server Hostname: localhost Server Port: 6060 Document Path: /test Document Length: 14 bytes Concurrency Level: 100 Time taken for tests: 510.">
</head>
<body><div class="sidebar .">
<div class=logo-title>
<div class=title>
<img src=/images/profile.jpg alt="profile picture">
<h3 title><a href=/>I'm Lei Zhang</a></h3>
<div class=description>
<p>This is my knowledge base. I document things here</p>
</div>
</div>
<p>
<a href=https://github.com/coolbeevip><img src="https://img.shields.io/github/followers/coolbeevip?label=follow&style=social" alt="GitHub coolbeevip"></a>
<img src=https://badges.pufler.dev/commits/all/coolbeevip alt="Commits Badge">
<img src=https://badges.pufler.dev/repos/coolbeevip alt="Repos Badge">
<img src=https://badges.pufler.dev/years/coolbeevip alt="Years Badge">
</p>
</div>
<ul class=social-links>
<li>
<a href=https://github.com/coolbeevip/ rel=me aria-label=GitHub>
<i class="fab fa-github fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=mailto:zhanglei@apache.org rel=me aria-label=e-mail>
<i class="fas fa-envelope fa-2x" aria-hidden=true></i>
</a>
</li>
</ul>
<div class=footer>
<div class=by_farbox>&copy; Lei Zhang 2021 </div>
</div>
</div>
<div class=main>
<div class="page-top .">
<a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<ul class=nav id=navMenu>
<li><a href=/ title>Home</a></li>
<li><a href=/posts title>Blog</a></li>
<li><a href=/bookmarks title>Bookmarks</a></li>
<li><a href=/about/ title>About</a></li>
</ul>
</div>
<div class=autopagerize_page_element>
<div class=content>
<div class="post .">
<div class=post-content>
<div class=post-title>
<h3>The Impact of Undertow Thread Options & Database Connection Pool on Performance</h3>
</div>
<p>Hikari 线程参数和数据库连接池参数对业务吞吐率的影响分析</p>
<h4 id=场景>场景</h4>
<p>本例中我们使用 Undertow 作为 Web 容器，使用 Hikari 作为数据库连接池，
并通过 <code>spring.datasource.hikari.maximum-pool-size</code> 和 <code>server.undertow.threads.worker</code> 两个参数的调整，看看对于业务的性能影响有多大</p>
<p>为此我准备了一个简单的 DEMO，并且执行 1000 次请求，并发 100，每次请求执行一个 SLEEP(5) 的 SQL模拟单笔耗时。并在一个 2C 的服务器上测试。应用默认参数如下</p>
<pre tabindex=0><code class=language-properties data-lang=properties>spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.minimum-idle=10
spring.datasource.hikari.maximum-pool-size=10
server.undertow.threads.worker(默认是 2C*8)
</code></pre><h4 id=默认参数>默认参数</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ ab -c <span style=color:#ae81ff>100</span> -n <span style=color:#ae81ff>1000</span> http://localhost:6060/test
This is ApacheBench, Version 2.3 &lt;$Revision: <span style=color:#ae81ff>1879490</span> $&gt;
Copyright <span style=color:#ae81ff>1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking localhost <span style=color:#f92672>(</span>be patient<span style=color:#f92672>)</span>
Completed <span style=color:#ae81ff>100</span> requests
Completed <span style=color:#ae81ff>200</span> requests
Completed <span style=color:#ae81ff>300</span> requests
Completed <span style=color:#ae81ff>400</span> requests
Completed <span style=color:#ae81ff>500</span> requests
Completed <span style=color:#ae81ff>600</span> requests
Completed <span style=color:#ae81ff>700</span> requests
Completed <span style=color:#ae81ff>800</span> requests
Completed <span style=color:#ae81ff>900</span> requests
Completed <span style=color:#ae81ff>1000</span> requests
Finished <span style=color:#ae81ff>1000</span> requests


Server Software:
Server Hostname:        localhost
Server Port:            <span style=color:#ae81ff>6060</span>

Document Path:          /test
Document Length:        <span style=color:#ae81ff>14</span> bytes

Concurrency Level:      <span style=color:#ae81ff>100</span>
Time taken <span style=color:#66d9ef>for</span> tests:   510.675 seconds
Complete requests:      <span style=color:#ae81ff>1000</span>
Failed requests:        <span style=color:#ae81ff>0</span>
Total transferred:      <span style=color:#ae81ff>121000</span> bytes
HTML transferred:       <span style=color:#ae81ff>14000</span> bytes
Requests per second:    1.96 <span style=color:#f92672>[</span><span style=color:#75715e>#/sec] (mean)</span>
Time per request:       51067.452 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean<span style=color:#f92672>)</span>
Time per request:       510.675 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean, across all concurrent requests<span style=color:#f92672>)</span>
Transfer rate:          0.23 <span style=color:#f92672>[</span>Kbytes/sec<span style=color:#f92672>]</span> received

Connection Times <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
              min  mean<span style=color:#f92672>[</span>+/-sd<span style=color:#f92672>]</span> median   max
Connect:        <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>1</span>   0.9      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>6</span>
Processing:  <span style=color:#ae81ff>5035</span> <span style=color:#ae81ff>48195</span> 8437.9  <span style=color:#ae81ff>50501</span>   <span style=color:#ae81ff>55617</span>
Waiting:     <span style=color:#ae81ff>5034</span> <span style=color:#ae81ff>48193</span> 8438.6  <span style=color:#ae81ff>50499</span>   <span style=color:#ae81ff>55612</span>
Total:       <span style=color:#ae81ff>5039</span> <span style=color:#ae81ff>48196</span> 8437.3  <span style=color:#ae81ff>50502</span>   <span style=color:#ae81ff>55618</span>
WARNING: The median and mean <span style=color:#66d9ef>for</span> the initial connection time are not within a normal deviation
        These results are probably not that reliable.

Percentage of the requests served within a certain time <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
  50%  <span style=color:#ae81ff>50502</span>
  66%  <span style=color:#ae81ff>50505</span>
  75%  <span style=color:#ae81ff>50507</span>
  80%  <span style=color:#ae81ff>50509</span>
  90%  <span style=color:#ae81ff>50575</span>
  95%  <span style=color:#ae81ff>50627</span>
  98%  <span style=color:#ae81ff>55482</span>
  99%  <span style=color:#ae81ff>55547</span>
 100%  <span style=color:#ae81ff>55618</span> <span style=color:#f92672>(</span>longest request<span style=color:#f92672>)</span>
</code></pre></div><p>直接上结论，如果并发 100 是产品经理提出的要求，那么<strong>这个系统生产不可用</strong></p>
<ul>
<li>50% 的请求返回需要 50 秒</li>
<li>1000 请求完成需要 8 分钟</li>
<li>处理平均耗时 50秒</li>
<li>请求平均等待 50秒</li>
</ul>
<h4 id=优化参数>优化参数</h4>
<p>实际上服务的请求处理耗时理论上应该是 SELECT SLEEP(5) FROM DUAL (模拟执行5秒)，但是从基准测试上看耗时远大于这个数。并且你可以通过日志查看到大部分 SQL 执行耗时确实是 5 秒。那么基本就可以确认性能瓶颈出现在吞吐上。</p>
<p>好吧，如果你的产品经理给你提出过性能指标，那么产品交付文档中应该指导交付团队配置合理参数</p>
<pre tabindex=0><code class=language-properties data-lang=properties>spring.datasource.hikari.minimum-idle=100 
spring.datasource.hikari.maximum-pool-size=100
server.undertow.threads.worker=200
</code></pre><p>再次测试</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ ab -c <span style=color:#ae81ff>100</span> -n <span style=color:#ae81ff>1000</span> http://localhost:6060/test
This is ApacheBench, Version 2.3 &lt;$Revision: <span style=color:#ae81ff>1879490</span> $&gt;
Copyright <span style=color:#ae81ff>1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking localhost <span style=color:#f92672>(</span>be patient<span style=color:#f92672>)</span>
Completed <span style=color:#ae81ff>100</span> requests
Completed <span style=color:#ae81ff>200</span> requests
Completed <span style=color:#ae81ff>300</span> requests
Completed <span style=color:#ae81ff>400</span> requests
Completed <span style=color:#ae81ff>500</span> requests
Completed <span style=color:#ae81ff>600</span> requests
Completed <span style=color:#ae81ff>700</span> requests
Completed <span style=color:#ae81ff>800</span> requests
Completed <span style=color:#ae81ff>900</span> requests
Completed <span style=color:#ae81ff>1000</span> requests
Finished <span style=color:#ae81ff>1000</span> requests


Server Software:
Server Hostname:        localhost
Server Port:            <span style=color:#ae81ff>6060</span>

Document Path:          /test
Document Length:        <span style=color:#ae81ff>14</span> bytes

Concurrency Level:      <span style=color:#ae81ff>100</span>
Time taken <span style=color:#66d9ef>for</span> tests:   81.252 seconds
Complete requests:      <span style=color:#ae81ff>1000</span>
Failed requests:        <span style=color:#ae81ff>0</span>
Total transferred:      <span style=color:#ae81ff>121000</span> bytes
HTML transferred:       <span style=color:#ae81ff>14000</span> bytes
Requests per second:    12.31 <span style=color:#f92672>[</span><span style=color:#75715e>#/sec] (mean)</span>
Time per request:       8125.207 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean<span style=color:#f92672>)</span>
Time per request:       81.252 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean, across all concurrent requests<span style=color:#f92672>)</span>
Transfer rate:          1.45 <span style=color:#f92672>[</span>Kbytes/sec<span style=color:#f92672>]</span> received

Connection Times <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
              min  mean<span style=color:#f92672>[</span>+/-sd<span style=color:#f92672>]</span> median   max
Connect:        <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>1</span>   1.1      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>8</span>
Processing:  <span style=color:#ae81ff>5023</span> <span style=color:#ae81ff>7010</span> 2292.8   <span style=color:#ae81ff>5279</span>   <span style=color:#ae81ff>14751</span>
Waiting:     <span style=color:#ae81ff>5023</span> <span style=color:#ae81ff>7007</span> 2293.2   <span style=color:#ae81ff>5276</span>   <span style=color:#ae81ff>14750</span>
Total:       <span style=color:#ae81ff>5023</span> <span style=color:#ae81ff>7011</span> 2292.7   <span style=color:#ae81ff>5280</span>   <span style=color:#ae81ff>14751</span>

Percentage of the requests served within a certain time <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
  50%   <span style=color:#ae81ff>5280</span>
  66%   <span style=color:#ae81ff>9786</span>
  75%   <span style=color:#ae81ff>9844</span>
  80%   <span style=color:#ae81ff>9874</span>
  90%   <span style=color:#ae81ff>9939</span>
  95%  <span style=color:#ae81ff>10006</span>
  98%  <span style=color:#ae81ff>10221</span>
  99%  <span style=color:#ae81ff>10285</span>
 100%  <span style=color:#ae81ff>14751</span> <span style=color:#f92672>(</span>longest request<span style=color:#f92672>)</span>
</code></pre></div><p>调整参数后，可以看到这比较符合预期（因为单笔耗时是5秒）。</p>
<ul>
<li>50% 的请求返回需要 5 秒</li>
<li>1000 请求完成需要 81 秒</li>
<li>处理平均耗时 5秒</li>
<li>请求平均等待 5秒</li>
</ul>
<h4 id=真正的瓶颈>真正的瓶颈</h4>
<p>系统真正的瓶颈还是单比业务耗时，假设我们可以优化到单笔业务耗时 1 秒，那么可以得到如下基准报告</p>
<ul>
<li>每秒能处理 58 笔请求</li>
<li>1000 笔请求可以在 16 秒处理完毕</li>
<li>90% 的请求都可以在 2 秒内处理完毕</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ ab -c <span style=color:#ae81ff>100</span> -n <span style=color:#ae81ff>1000</span> http://localhost:6060/test
This is ApacheBench, Version 2.3 &lt;$Revision: <span style=color:#ae81ff>1879490</span> $&gt;
Copyright <span style=color:#ae81ff>1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking localhost <span style=color:#f92672>(</span>be patient<span style=color:#f92672>)</span>
Completed <span style=color:#ae81ff>100</span> requests
Completed <span style=color:#ae81ff>200</span> requests
Completed <span style=color:#ae81ff>300</span> requests
Completed <span style=color:#ae81ff>400</span> requests
Completed <span style=color:#ae81ff>500</span> requests
Completed <span style=color:#ae81ff>600</span> requests
Completed <span style=color:#ae81ff>700</span> requests
Completed <span style=color:#ae81ff>800</span> requests
Completed <span style=color:#ae81ff>900</span> requests
Completed <span style=color:#ae81ff>1000</span> requests
Finished <span style=color:#ae81ff>1000</span> requests


Server Software:
Server Hostname:        localhost
Server Port:            <span style=color:#ae81ff>6060</span>

Document Path:          /test
Document Length:        <span style=color:#ae81ff>14</span> bytes

Concurrency Level:      <span style=color:#ae81ff>100</span>
Time taken <span style=color:#66d9ef>for</span> tests:   16.967 seconds
Complete requests:      <span style=color:#ae81ff>1000</span>
Failed requests:        <span style=color:#ae81ff>0</span>
Total transferred:      <span style=color:#ae81ff>121000</span> bytes
HTML transferred:       <span style=color:#ae81ff>14000</span> bytes
Requests per second:    58.94 <span style=color:#f92672>[</span><span style=color:#75715e>#/sec] (mean)</span>
Time per request:       1696.661 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean<span style=color:#f92672>)</span>
Time per request:       16.967 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean, across all concurrent requests<span style=color:#f92672>)</span>
Transfer rate:          6.96 <span style=color:#f92672>[</span>Kbytes/sec<span style=color:#f92672>]</span> received

Connection Times <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
              min  mean<span style=color:#f92672>[</span>+/-sd<span style=color:#f92672>]</span> median   max
Connect:        <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>1</span>   2.5      <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>24</span>
Processing:  <span style=color:#ae81ff>1010</span> <span style=color:#ae81ff>1469</span> 324.6   <span style=color:#ae81ff>1366</span>    <span style=color:#ae81ff>2469</span>
Waiting:     <span style=color:#ae81ff>1010</span> <span style=color:#ae81ff>1466</span> 324.9   <span style=color:#ae81ff>1363</span>    <span style=color:#ae81ff>2469</span>
Total:       <span style=color:#ae81ff>1010</span> <span style=color:#ae81ff>1470</span> 324.4   <span style=color:#ae81ff>1369</span>    <span style=color:#ae81ff>2472</span>

Percentage of the requests served within a certain time <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
  50%   <span style=color:#ae81ff>1369</span>
  66%   <span style=color:#ae81ff>1582</span>
  75%   <span style=color:#ae81ff>1721</span>
  80%   <span style=color:#ae81ff>1737</span>
  90%   <span style=color:#ae81ff>1952</span>
  95%   <span style=color:#ae81ff>2070</span>
  98%   <span style=color:#ae81ff>2316</span>
  99%   <span style=color:#ae81ff>2337</span>
 100%   <span style=color:#ae81ff>2472</span> <span style=color:#f92672>(</span>longest request<span style=color:#f92672>)</span>
</code></pre></div></div>
<div class=post-footer>
<div class=info>
<span class=separator><a class=category href=/categories/java/>java</a></span>
<span class=separator><a class=tag href=/tags/undertow/>undertow</a><a class=tag href=/tags/hikari/>hikari</a></span>
</div>
</div>
</div>
</div>
</div>
</div>
<script type=text/javascript src=/js/medium-zoom.min.2d6fd0be87fa98f0c9b4dc2536b312bbca48757f584f6ea1f394abc9bcc38fbc.js integrity="sha256-LW/Qvof6mPDJtNwlNrMSu8pIdX9YT26h85SrybzDj7w=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css integrity=sha384-t5CR+zwDAROtph0PXGte6ia8heboACF9R5l/DiY+WZ3P2lxNgvJkQk5n7GPvLMYw crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js integrity=sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8+w2LAIftJEULZABrF9PPFv+tVkH crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js integrity=sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB+w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v crossorigin=anonymous onload=renderMathInElement(document.body)></script></body>
</html>