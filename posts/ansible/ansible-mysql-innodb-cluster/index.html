<!doctype html><html lang=en data-theme><head>
<title> Lei Zhang | Install MySQL InnoDB Cluster with Ansible Playbook </title>
<meta charset=utf-8><meta name=generator content="Hugo 0.89.4"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=description content="This is my knowledge base. I document things here">
<link rel=stylesheet href=/css/style.min.7cf3c5090ac13256a5fa5531e5649cfe5a2ba7de88dca14ce0b6e253409a3511.css integrity="sha256-fPPFCQrBMlal+lUx5WSc/lorp96I3KFM4LbiU0CaNRE=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS+yuWSR4=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/css/custom.min.3fa691134fafa8351e9d193939a352647c1ae886828bdefa3f5a272653dbf7e4.css integrity="sha256-P6aRE0+vqDUenRk5OaNSZHwa6IaCi976P1onJlPb9+Q=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous>
<link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png>
<link rel=canonical href=/posts/ansible/ansible-mysql-innodb-cluster/>
<script type=text/javascript src=/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin=anonymous></script>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Install MySQL InnoDB Cluster with Ansible Playbook">
<meta name=twitter:description content="集群概述 MySQL InnoDB Cluster 是 MySQL 团队为了高可用性 (HA) 目的而引入的。它为 MySQL 提供了完整的高可用解决方案。
我将通过 Ansible Playbook 展示三个节点的 InnoDB 集群配置。
MySQL InnoDB 集群有以下服务组成
 MySQL shell Group Replication ( GR ) MySQL Router  安装计划 服务器规划
   IP地址 SSH 端口 SSH 用户名 SSH 密码 ROOT 密码     10.1.207.180 22022 mysql 123456 root123   10.1.207.181 22022 mysql 123456 root123   10.1.207.182 22022 mysql 123456 root123    集群节点规划">
</head>
<body><div class="sidebar .">
<div class=logo-title>
<div class=title>
<img src=/images/profile.jpg alt="profile picture">
<h3 title><a href=/>I'm Lei Zhang</a></h3>
<div class=description>
<p>This is my knowledge base. I document things here</p>
</div>
</div>
<p>
<a href=https://github.com/coolbeevip><img src="https://img.shields.io/github/followers/coolbeevip?label=follow&style=social" alt="GitHub coolbeevip"></a>
<img src=https://badges.pufler.dev/commits/all/coolbeevip alt="Commits Badge">
<img src=https://badges.pufler.dev/repos/coolbeevip alt="Repos Badge">
<img src=https://badges.pufler.dev/years/coolbeevip alt="Years Badge">
</p>
</div>
<ul class=social-links>
<li>
<a href=https://github.com/coolbeevip/ rel=me aria-label=GitHub>
<i class="fab fa-github fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=mailto:zhanglei@apache.org rel=me aria-label=e-mail>
<i class="fas fa-envelope fa-2x" aria-hidden=true></i>
</a>
</li>
</ul>
<div class=footer>
<div class=by_farbox>&copy; Lei Zhang 2021 </div>
</div>
</div>
<div class=main>
<div class="page-top .">
<a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<ul class=nav id=navMenu>
<li><a href=/ title>Home</a></li>
<li><a href=/posts title>Blog</a></li>
<li><a href=/bookmarks title>Bookmarks</a></li>
<li><a href=/about/ title>About</a></li>
</ul>
</div>
<div class=autopagerize_page_element>
<div class=content>
<div class="post .">
<div class=post-content>
<div class=post-title>
<h3>Install MySQL InnoDB Cluster with Ansible Playbook</h3>
</div>
<h2 id=集群概述>集群概述</h2>
<p>MySQL InnoDB Cluster 是 MySQL 团队为了高可用性 (HA) 目的而引入的。它为 MySQL 提供了完整的高可用解决方案。</p>
<p><img src=/images/posts/ansible/ansible-mysql-innodb-cluster/mysql-innodb-cluster-architecture.png alt=image-apisix-dashboard></p>
<p>我将通过 Ansible Playbook 展示三个节点的 InnoDB 集群配置。</p>
<p>MySQL InnoDB 集群有以下服务组成</p>
<ul>
<li>MySQL shell</li>
<li>Group Replication ( GR )</li>
<li>MySQL Router</li>
</ul>
<h2 id=安装计划>安装计划</h2>
<p>服务器规划</p>
<table>
<thead>
<tr>
<th>IP地址</th>
<th>SSH 端口</th>
<th>SSH 用户名</th>
<th>SSH 密码</th>
<th>ROOT 密码</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.1.207.180</td>
<td>22022</td>
<td>mysql</td>
<td>123456</td>
<td>root123</td>
</tr>
<tr>
<td>10.1.207.181</td>
<td>22022</td>
<td>mysql</td>
<td>123456</td>
<td>root123</td>
</tr>
<tr>
<td>10.1.207.182</td>
<td>22022</td>
<td>mysql</td>
<td>123456</td>
<td>root123</td>
</tr>
</tbody>
</table>
<p>集群节点规划</p>
<table>
<thead>
<tr>
<th>IP地址</th>
<th>模块</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.1.207.180</td>
<td>MySQL Primary Node, MySQL Router</td>
</tr>
<tr>
<td>10.1.207.181</td>
<td>MySQL Secondary Node, MySQL Router</td>
</tr>
<tr>
<td>10.1.207.182</td>
<td>MySQL Secondary Node, MySQL Router</td>
</tr>
</tbody>
</table>
<p>节点安装路径</p>
<blockquote>
<p>以下路径是默认路径，在安装前可以编辑 <code>var_mysql.yml</code> 中的变量改变成你想要的路径，其中路径变量中包含 <strong>_fast_</strong> 字样的路径建议你定义在 SSD 磁盘上</p>
</blockquote>
<table>
<thead>
<tr>
<th>路径</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>/etc/hosts</td>
<td>所有节点 IP 地址和主机名映射</td>
</tr>
<tr>
<td>/opt/mysql</td>
<td>MySQL server、MySQL Shell、MySQL router 程序安装路径</td>
</tr>
<tr>
<td>~/.bash_profile</td>
<td>设置 MySQL 环境变量</td>
</tr>
<tr>
<td>~/.my.cnf</td>
<td>MySQL 配置文件</td>
</tr>
<tr>
<td>~/mysql_uninstall.sh</td>
<td>MySQL InnoDB 集群卸载脚本</td>
</tr>
<tr>
<td>~/mysql.server</td>
<td>MySQL server 的启停脚本</td>
</tr>
<tr>
<td>~/mysql_router_start.sh</td>
<td>MySQL router 启动脚本软连接</td>
</tr>
<tr>
<td>~/mysql_router_stop.sh</td>
<td>MySQL router 停止脚本软连接</td>
</tr>
<tr>
<td>/data01/mysql/run</td>
<td>MySQL server pid 文件路径</td>
</tr>
<tr>
<td>/data01/mysql/logs</td>
<td>MySQL server 日志文件路径</td>
</tr>
<tr>
<td>/data01/mysql/data</td>
<td>MySQL server 数据文件路径</td>
</tr>
<tr>
<td>/data01/mysql/dump</td>
<td>MySQL server 只允许在这个目录下进行导入导出操作</td>
</tr>
<tr>
<td>/data01/mysql/script</td>
<td>安装过程中临时脚本存放的目录</td>
</tr>
<tr>
<td>/data01/mysql/binlog</td>
<td>MySQL server bin-log 文件存储路径</td>
</tr>
<tr>
<td>/data01/mysql/relaylog</td>
<td>MySQL server relay-log 文件存储路径</td>
</tr>
<tr>
<td>/data01/mysql/router/mycluster</td>
<td>MySQL router 的配置文件、数据文件、日志文件</td>
</tr>
</tbody>
</table>
<p><strong>提示:</strong> 系统自带 /etc/my.cnf /etc/mysql/my.cnf 文件将被重命名为 /etc/my.cnf.deleted /etc/mysql/my.cnf.deleted</p>
<h2 id=下载安装包和-playbook-脚本>下载安装包和 Playbook 脚本</h2>
<p>在客户机上创建 playbook 脚本存放目录</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mkdir -p ~/my-docker-volume/ansible-playbook
</code></pre></div><p>下载 playbook 脚本</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cd ~/my-docker-volume/ansible-playbook
git clone https://github.com/coolbeevip/ansible-playbook.git
</code></pre></div><p>下载 MySQL 安装包到 <code>~/my-docker-volume/ansible-playbook/packages</code> 目录</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>wget -P ~/my-docker-volume/ansible-playbook/packages http://ftp.ntu.edu.tw/MySQL/Downloads/MySQL-8.0/mysql-8.0.27-linux-glibc2.12-x86_64.tar.xz --no-check-certificate
wget -P ~/my-docker-volume/ansible-playbook/packages http://ftp.ntu.edu.tw/MySQL/Downloads/MySQL-Shell/mysql-shell-8.0.27-linux-glibc2.12-x86-64bit.tar.gz --no-check-certificate
wget -P ~/my-docker-volume/ansible-playbook/packages http://ftp.ntu.edu.tw/MySQL/Downloads/MySQL-Router/mysql-router-8.0.27-linux-glibc2.12-x86_64.tar.xz --no-check-certificate
</code></pre></div><h2 id=配置安装脚本>配置安装脚本</h2>
<blockquote>
<p>您可以编辑以下配置文件，修改默认参数</p>
</blockquote>
<h4 id=main-mysqlyml>main-mysql.yml</h4>
<p>安装 MySQL Server 的服务器 IP 地址，以及系统用户名</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>- hosts: 10.1.207.180
  user: mysql

- hosts: 10.1.207.181
  user: mysql

- hosts: 10.1.207.182
  user: mysql
</code></pre></div><h4 id=main-clusteryml>main-cluster.yml</h4>
<p>配置 MySQL 集群主节点的服务器 IP 地址，以及系统用户名</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>- hosts: 10.1.207.180
  user: mysql
</code></pre></div><h4 id=main-routeryml>main-router.yml</h4>
<p>安装 MySQL Router 的服务器 IP 地址，以及系统用户名</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>- hosts: 10.1.207.180
  user: mysql

- hosts: 10.1.207.181
  user: mysql

- hosts: 10.1.207.182
  user: mysql
</code></pre></div><h4 id=vars_mysqlyml>vars_mysql.yml</h4>
<p>主机 IP 地址以及主机名映射关系</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># Linux Mapping of IP addresses to hostname /etc/hosts</span>
hosts:
  10.1.207.180: oss-irms-180
  10.1.207.181: oss-irms-181
  10.1.207.182: oss-irms-182
</code></pre></div><p>操作系统 Limits</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># Linux limits</span>
limits_hard_nproc: <span style=color:#e6db74>&#39;65535&#39;</span>
limits_soft_nproc: <span style=color:#e6db74>&#39;65535&#39;</span>
limits_hard_nofile: <span style=color:#e6db74>&#39;65535&#39;</span>
limits_soft_nofile: <span style=color:#e6db74>&#39;65535&#39;</span>
</code></pre></div><p>安装用的用户名、用户组</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># Linux user &amp; group</span>
mysql_user: <span style=color:#e6db74>&#34;mysql&#34;</span>
mysql_group: <span style=color:#e6db74>&#34;mysql&#34;</span>
</code></pre></div><p>安装介质名称以及解压后的目录名</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># MySQL server package</span>
mysql_tar: <span style=color:#e6db74>&#34;mysql-8.0.27-linux-glibc2.12-x86_64.tar.xz&#34;</span>
mysql_tar_unzip_dir: <span style=color:#e6db74>&#34;mysql-8.0.27-linux-glibc2.12-x86_64&#34;</span>

<span style=color:#75715e># MySQL shell package</span>
mysql_shell_tar: <span style=color:#e6db74>&#34;mysql-shell-8.0.27-linux-glibc2.12-x86-64bit.tar.gz&#34;</span>
mysql_shell_tar_unzip_dir: <span style=color:#e6db74>&#34;mysql-shell-8.0.27-linux-glibc2.12-x86-64bit&#34;</span>

<span style=color:#75715e># MySQL router package</span>
mysql_router_tar: <span style=color:#e6db74>&#34;mysql-router-8.0.27-linux-glibc2.12-x86_64.tar.xz&#34;</span>
mysql_router_tar_unzip_dir: <span style=color:#e6db74>&#34;mysql-router-8.0.27-linux-glibc2.12-x86_64&#34;</span>
</code></pre></div><p>安装路径</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># MySQL InnoDB Cluster install directory</span>
mysql_home_dir: <span style=color:#e6db74>&#34;/opt/mysql&#34;</span>
mysql_run_dir: <span style=color:#e6db74>&#34;/data01/mysql/run&#34;</span>
mysql_log_dir: <span style=color:#e6db74>&#34;/data01/mysql/logs&#34;</span>
mysql_data_dir: <span style=color:#e6db74>&#34;/data01/mysql/data&#34;</span>
mysql_dump_dir: <span style=color:#e6db74>&#34;/data01/mysql/dump&#34;</span>
mysql_script_dir: <span style=color:#e6db74>&#34;/data01/mysql/script&#34;</span>
<span style=color:#75715e>## SSD disk is recommended for fast directory</span>
mysql_fast_data_dir: <span style=color:#e6db74>&#34;/data01/mysql/data&#34;</span>
mysql_fast_binlog_dir: <span style=color:#e6db74>&#34;/data01/mysql/binlog&#34;</span>
mysql_fast_relaylog_dir: <span style=color:#e6db74>&#34;/data01/mysql/relaylog&#34;</span>
<span style=color:#75715e>## MySQL router work directory</span>
mysql_router_dir: <span style=color:#e6db74>&#34;/data01/mysql/router&#34;</span>
</code></pre></div><p>MySQL root 初始化密码</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># Root initialization password, special characters are not recommended, for examples !@#$% etc.</span>
mysql_user_root_password: <span style=color:#e6db74>&#34;CoolbeevipWowo&#34;</span>
</code></pre></div><p>MySQL server 配置</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># MySQL server configuration my.conf</span>
mysqld_port: <span style=color:#ae81ff>3336</span>
mysqld_max_connections: <span style=color:#ae81ff>1000</span>
mysqld_max_connect_errors: <span style=color:#ae81ff>300</span>
mysqld_default_time_zone: <span style=color:#e6db74>&#34;+08:00&#34;</span>
mysqld_mysqlx_port: <span style=color:#ae81ff>33360</span>
mysqld_group_replication_port: <span style=color:#ae81ff>33361</span>
mysqld_character_set_server: utf8mb4
mysqld_collation_server: utf8mb4_general_ci
mysqld_innodb_buffer_pool_size: 10G
client_default_character_set: utf8mb4
</code></pre></div><p>MySQL cluster 配置</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># MySQL Cluster</span>
cluster_name: mycluster
</code></pre></div><p>MySQL router 配置</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># MySQL Router configuration</span>
mysql_router_base_port: <span style=color:#ae81ff>36446</span>
mysql_router_max_connections: <span style=color:#ae81ff>3000</span>
mysql_router_max_connect_errors: <span style=color:#ae81ff>300</span>
</code></pre></div><h4 id=mycnfj2>my.cnf.j2</h4>
<p>更多的 my.cnf 配置你可以直接修改 mysql/conf/my.cnf.j2 模版文件</p>
<h2 id=开始安装>开始安装</h2>
<p>启动 ansible 容器工具连接目标服务器，并将 <code>~/my-docker-volume/ansible-playbook</code> 目录挂载到容器中。</p>
<p><strong>提示：</strong> ANSIBLE_SSH_USERS，ANSIBLE_SSH_PASSS 配置成您之前在目标服务器上创建的用户名 <code>mysql</code> 和密码 <code>123456</code></p>
<p><strong>提示：</strong> ANSIBLE_SU_PASSS 为 root 用户的密码</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker run --name ansible --rm -it <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e ANSIBLE_SSH_HOSTS<span style=color:#f92672>=</span>10.1.207.180,10.1.207.181,10.1.207.182 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e ANSIBLE_SSH_PORTS<span style=color:#f92672>=</span>22022,22022,22022 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e ANSIBLE_SSH_USERS<span style=color:#f92672>=</span>mysql,mysql,mysql <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e ANSIBLE_SSH_PASSS<span style=color:#f92672>=</span>123456,123456,123456 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e ANSIBLE_SU_PASSS<span style=color:#f92672>=</span>root123,root123,root123 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -v /Users/zhanglei/mydocker/volume/ansible-playbook:/ansible-playbook <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  coolbeevip/ansible:2.8.11-alpine <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  /bin/bash  
</code></pre></div><h4 id=安装三节点-mysql-server>安装三节点 MySQL server</h4>
<p>执行安装脚本</p>
<blockquote>
<p>此命令会配置操作系统内核参数、自动上传安装介质到三个目标服务器，设置 MySQL 环境变量，初始化 MySQL 数据库，设置 MySQL root 密码，启动 MySQL 服务</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible-playbook -C /ansible-playbook/mysql/main-mysql.yml
</code></pre></div><p><strong>提示：</strong> 此脚本首次执行耗时较长（因为需要上传约 1.3GB 的安装介质到所有目标服务器）。排除上传介质的耗时，此脚本在我的环境下执行耗时大约 6 分钟</p>
<p>检查 MySQL 节点状态</p>
<blockquote>
<p>可以看到三台服务器上的 MySQL 服务都已经启动</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;~/mysql.server status&#39;</span>
10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
 SUCCESS! MySQL running <span style=color:#f92672>(</span>25729<span style=color:#f92672>)</span>

10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
 SUCCESS! MySQL running <span style=color:#f92672>(</span>9462<span style=color:#f92672>)</span>

10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
 SUCCESS! MySQL running <span style=color:#f92672>(</span>28934<span style=color:#f92672>)</span>
</code></pre></div><p>校验 MySQL 三节点之间是否可以正常连接</p>
<blockquote>
<p>在创建集群前，我们需要确认MySQL实例间可以彼此连接。当你看到 <strong>The instance &lsquo;xxx&rsquo; is valid to be used in an InnoDB cluster.</strong> 提示时，说明连接正常</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible 10.1.207.180 -m shell -a <span style=color:#e6db74>&#39;source ~/.bash_profile &amp;&amp; mysqlsh --no-password &lt; /data01/mysql/script/mysql_members_validate.sql&#39;</span>
10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;

Checking whether existing tables comply with Group Replication requirements...
Checking instance configuration...
Checking whether existing tables comply with Group Replication requirements...
Checking instance configuration...

Checking whether existing tables comply with Group Replication requirements...
Checking instance configuration...Validating local MySQL instance listening at port <span style=color:#ae81ff>3336</span> <span style=color:#66d9ef>for</span> use in an InnoDB cluster...
This instance reports its own address as oss-irms-180:3336
Clients and other cluster members will communicate with it through this address by default. If this is not correct, the report_host MySQL system variable should be changed.
No incompatible tables detected
Instance configuration is compatible with InnoDB cluster
The instance <span style=color:#e6db74>&#39;oss-irms-180:3336&#39;</span> is valid to be used in an InnoDB cluster.
Validating MySQL instance at oss-irms-181:3336 <span style=color:#66d9ef>for</span> use in an InnoDB cluster...
This instance reports its own address as oss-irms-181:3336
Clients and other cluster members will communicate with it through this address by default. If this is not correct, the report_host MySQL system variable should be changed.
No incompatible tables detected
Instance configuration is compatible with InnoDB cluster
The instance <span style=color:#e6db74>&#39;oss-irms-181:3336&#39;</span> is valid to be used in an InnoDB cluster.
Validating MySQL instance at oss-irms-182:3336 <span style=color:#66d9ef>for</span> use in an InnoDB cluster...
This instance reports its own address as oss-irms-182:3336
Clients and other cluster members will communicate with it through this address by default. If this is not correct, the report_host MySQL system variable should be changed.
No incompatible tables detected
Instance configuration is compatible with InnoDB cluster
The instance <span style=color:#e6db74>&#39;oss-irms-182:3336&#39;</span> is valid to be used in an InnoDB cluster.
</code></pre></div><h4 id=配置-mysql-集群>配置 MySQL 集群</h4>
<blockquote>
<p>这个脚本将在主节点上创建集群并将两个从节点加入到集群</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible-playbook -C /ansible-playbook/mysql/main-cluster.yml
</code></pre></div><p><strong>提示：</strong> 此脚本执行过程中 MySQL 实例会自动重启并等待同步主节点和从节点数据，在我的环境下执行耗时大约 4 分钟。</p>
<p><strong>提示：</strong> 此脚本执行结束后你可以看到如下集群状态信息，一个读写模式的 PRIMARY 节点 <code>oss-irms-180</code>；两个具有只读模式的 SECONDARY 节点 <code>oss-irms-181</code> 和 <code>oss-irms-182</code>。并且三个节点都处于 ONLINE 状态</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>TASK <span style=color:#f92672>[</span>check mysql_cluster_status output<span style=color:#f92672>]</span> *******************************************************************************************************************************************************************
ok: <span style=color:#f92672>[</span>10.1.207.180<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;check_result.stdout_lines&#34;</span>: <span style=color:#f92672>[</span>
        <span style=color:#e6db74>&#34;{&#34;</span>,
        <span style=color:#e6db74>&#34;    \&#34;clusterName\&#34;: \&#34;mycluster\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;    \&#34;defaultReplicaSet\&#34;: {&#34;</span>,
        <span style=color:#e6db74>&#34;        \&#34;name\&#34;: \&#34;default\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;        \&#34;primary\&#34;: \&#34;oss-irms-180:3336\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;        \&#34;ssl\&#34;: \&#34;REQUIRED\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;        \&#34;status\&#34;: \&#34;OK\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;        \&#34;statusText\&#34;: \&#34;Cluster is ONLINE and can tolerate up to ONE failure.\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;        \&#34;topology\&#34;: {&#34;</span>,
        <span style=color:#e6db74>&#34;            \&#34;oss-irms-180:3336\&#34;: {&#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;address\&#34;: \&#34;oss-irms-180:3336\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;memberRole\&#34;: \&#34;PRIMARY\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;mode\&#34;: \&#34;R/W\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;readReplicas\&#34;: {}, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;replicationLag\&#34;: null, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;role\&#34;: \&#34;HA\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;status\&#34;: \&#34;ONLINE\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;version\&#34;: \&#34;8.0.27\&#34;&#34;</span>,
        <span style=color:#e6db74>&#34;            }, &#34;</span>,
        <span style=color:#e6db74>&#34;            \&#34;oss-irms-181:3336\&#34;: {&#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;address\&#34;: \&#34;oss-irms-181:3336\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;memberRole\&#34;: \&#34;SECONDARY\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;mode\&#34;: \&#34;R/O\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;readReplicas\&#34;: {}, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;replicationLag\&#34;: null, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;role\&#34;: \&#34;HA\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;status\&#34;: \&#34;ONLINE\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;version\&#34;: \&#34;8.0.27\&#34;&#34;</span>,
        <span style=color:#e6db74>&#34;            }, &#34;</span>,
        <span style=color:#e6db74>&#34;            \&#34;oss-irms-182:3336\&#34;: {&#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;address\&#34;: \&#34;oss-irms-182:3336\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;memberRole\&#34;: \&#34;SECONDARY\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;mode\&#34;: \&#34;R/O\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;readReplicas\&#34;: {}, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;replicationLag\&#34;: null, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;role\&#34;: \&#34;HA\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;status\&#34;: \&#34;ONLINE\&#34;, &#34;</span>,
        <span style=color:#e6db74>&#34;                \&#34;version\&#34;: \&#34;8.0.27\&#34;&#34;</span>,
        <span style=color:#e6db74>&#34;            }&#34;</span>,
        <span style=color:#e6db74>&#34;        }, &#34;</span>,
        <span style=color:#e6db74>&#34;        \&#34;topologyMode\&#34;: \&#34;Single-Primary\&#34;&#34;</span>,
        <span style=color:#e6db74>&#34;    }, &#34;</span>,
        <span style=color:#e6db74>&#34;    \&#34;groupInformationSourceMember\&#34;: \&#34;oss-irms-180:3336\&#34;&#34;</span>,
        <span style=color:#e6db74>&#34;}&#34;</span>
    <span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>
</code></pre></div><p><strong>提示：</strong> 更多集群说明请参见 <a href=https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-innodb-cluster.html>MySQL InnoDB Cluster</a></p>
<h4 id=安装-mysql-router>安装 MySQL router</h4>
<p>安装前检查</p>
<blockquote>
<p>需要允许基于主机名和 IP 的集群节点之间的完整通信。通常在安装之前的脚本的时候已经自动修改了 /etc/hosts 文件。</p>
</blockquote>
<p>查看每个机器的主机名</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;hostname&#39;</span>
10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
oss-irms-181

10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
oss-irms-180

10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
oss-irms-182
</code></pre></div><p>查看每个主机 /etc/hosts 文件中是否配置了每个服务器的主机名和IP地址</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;cat /etc/hosts&#39;</span>
10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.1.207.180 oss-irms-180
10.1.207.181 oss-irms-181
10.1.207.182 oss-irms-182

10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.1.207.180 oss-irms-180
10.1.207.181 oss-irms-181
10.1.207.182 oss-irms-182

10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.1.207.180 oss-irms-180
10.1.207.181 oss-irms-181
10.1.207.182 oss-irms-182
</code></pre></div><p>执行 MySQL router 安装脚本 <code>main-router.yml</code></p>
<blockquote>
<p>此脚本将自动生成 mysqlrouter.conf 配置文件，并启动 MySQL Router 服务</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible-playbook -C /ansible-playbook/mysql/main-router.yml
</code></pre></div><p>查看 MySQL Router 进程</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;ps -ef | grep mysql-router&#39;</span>
10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
mysql    <span style=color:#ae81ff>30445</span>     <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>1</span> 17:05 ?        00:00:02 /opt/mysql/mysql-router-8.0.27-linux-glibc2.12-x86_64/bin/mysqlrouter -c /data01/mysql/router/mycluster/mysqlrouter.conf
mysql    <span style=color:#ae81ff>30993</span> <span style=color:#ae81ff>30991</span>  <span style=color:#ae81ff>0</span> 17:07 pts/1    00:00:00 /bin/sh -c ps -ef | grep mysql-router
mysql    <span style=color:#ae81ff>31000</span> <span style=color:#ae81ff>30993</span>  <span style=color:#ae81ff>0</span> 17:07 pts/1    00:00:00 grep mysql-router

10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
mysql    <span style=color:#ae81ff>26006</span>     <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>1</span> 17:01 ?        00:00:02 /opt/mysql/mysql-router-8.0.27-linux-glibc2.12-x86_64/bin/mysqlrouter -c /data01/mysql/router/mycluster/mysqlrouter.conf
mysql    <span style=color:#ae81ff>26376</span> <span style=color:#ae81ff>26375</span>  <span style=color:#ae81ff>0</span> 17:03 pts/2    00:00:00 /bin/sh -c ps -ef | grep mysql-router
mysql    <span style=color:#ae81ff>26378</span> <span style=color:#ae81ff>26376</span>  <span style=color:#ae81ff>0</span> 17:03 pts/2    00:00:00 grep mysql-router

10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
mysql    <span style=color:#ae81ff>16000</span>     <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>1</span> 17:01 ?        00:00:02 /opt/mysql/mysql-router-8.0.27-linux-glibc2.12-x86_64/bin/mysqlrouter -c /data01/mysql/router/mycluster/mysqlrouter.conf
mysql    <span style=color:#ae81ff>16463</span> <span style=color:#ae81ff>16462</span>  <span style=color:#ae81ff>0</span> 17:03 pts/3    00:00:00 /bin/sh -c ps -ef | grep mysql-router
mysql    <span style=color:#ae81ff>16465</span> <span style=color:#ae81ff>16463</span>  <span style=color:#ae81ff>0</span> 17:03 pts/3    00:00:00 grep mysql-router
</code></pre></div><p>测试通过 MySQL Router RW 端口 <strong>36446</strong> 连接数据库主节点执行查看 MGR 组信息</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;source ~/.bash_profile &amp;&amp; mysql -h 10.1.207.180 -P 36446 -uroot -pCoolbeevipWowo mysql -e &#34;select * from performance_schema.replication_group_members;&#34;&#39;</span>
10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
CHANNEL_NAME	MEMBER_ID	MEMBER_HOST	MEMBER_PORT	MEMBER_STATE	MEMBER_ROLE	MEMBER_VERSION	MEMBER_COMMUNICATION_STACK
group_replication_applier	5e11bf00-4cf5-11ec-8798-5254005e1dd1	oss-irms-181	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	93a9227d-4cf5-11ec-9851-5254001a7e4c	oss-irms-182	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	9aed150e-4cf5-11ec-8819-525400506ca8	oss-irms-180	3336	ONLINE	PRIMARY	8.0.27	XCommysql: <span style=color:#f92672>[</span>Warning<span style=color:#f92672>]</span> Using a password on the command line interface can be insecure.

10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
CHANNEL_NAME	MEMBER_ID	MEMBER_HOST	MEMBER_PORT	MEMBER_STATE	MEMBER_ROLE	MEMBER_VERSION	MEMBER_COMMUNICATION_STACK
group_replication_applier	5e11bf00-4cf5-11ec-8798-5254005e1dd1	oss-irms-181	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	93a9227d-4cf5-11ec-9851-5254001a7e4c	oss-irms-182	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	9aed150e-4cf5-11ec-8819-525400506ca8	oss-irms-180	3336	ONLINE	PRIMARY	8.0.27	XCommysql: <span style=color:#f92672>[</span>Warning<span style=color:#f92672>]</span> Using a password on the command line interface can be insecure.

10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
CHANNEL_NAME	MEMBER_ID	MEMBER_HOST	MEMBER_PORT	MEMBER_STATE	MEMBER_ROLE	MEMBER_VERSION	MEMBER_COMMUNICATION_STACK
group_replication_applier	5e11bf00-4cf5-11ec-8798-5254005e1dd1	oss-irms-181	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	93a9227d-4cf5-11ec-9851-5254001a7e4c	oss-irms-182	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	9aed150e-4cf5-11ec-8819-525400506ca8	oss-irms-180	3336	ONLINE	PRIMARY	8.0.27	XCommysql: <span style=color:#f92672>[</span>Warning<span style=color:#f92672>]</span> Using a password on the command line interface can be insecure.
</code></pre></div><p>测试通过 MySQL Router RO 端口 <strong>36447</strong> 连接数据库从节点执行查看 MGR 组信息</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;source ~/.bash_profile &amp;&amp; mysql -h 10.1.207.180 -P 36447 -uroot -pCoolbeevipWowo mysql -e &#34;select * from performance_schema.replication_group_members;&#34;&#39;</span>
10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
CHANNEL_NAME	MEMBER_ID	MEMBER_HOST	MEMBER_PORT	MEMBER_STATE	MEMBER_ROLE	MEMBER_VERSION	MEMBER_COMMUNICATION_STACK
group_replication_applier	5e11bf00-4cf5-11ec-8798-5254005e1dd1	oss-irms-181	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	93a9227d-4cf5-11ec-9851-5254001a7e4c	oss-irms-182	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	9aed150e-4cf5-11ec-8819-525400506ca8	oss-irms-180	3336	ONLINE	PRIMARY	8.0.27	XCommysql: <span style=color:#f92672>[</span>Warning<span style=color:#f92672>]</span> Using a password on the command line interface can be insecure.

10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
CHANNEL_NAME	MEMBER_ID	MEMBER_HOST	MEMBER_PORT	MEMBER_STATE	MEMBER_ROLE	MEMBER_VERSION	MEMBER_COMMUNICATION_STACK
group_replication_applier	5e11bf00-4cf5-11ec-8798-5254005e1dd1	oss-irms-181	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	93a9227d-4cf5-11ec-9851-5254001a7e4c	oss-irms-182	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	9aed150e-4cf5-11ec-8819-525400506ca8	oss-irms-180	3336	ONLINE	PRIMARY	8.0.27	XCommysql: <span style=color:#f92672>[</span>Warning<span style=color:#f92672>]</span> Using a password on the command line interface can be insecure.

10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
CHANNEL_NAME	MEMBER_ID	MEMBER_HOST	MEMBER_PORT	MEMBER_STATE	MEMBER_ROLE	MEMBER_VERSION	MEMBER_COMMUNICATION_STACK
group_replication_applier	5e11bf00-4cf5-11ec-8798-5254005e1dd1	oss-irms-181	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	93a9227d-4cf5-11ec-9851-5254001a7e4c	oss-irms-182	3336	ONLINE	SECONDARY	8.0.27	XCom
group_replication_applier	9aed150e-4cf5-11ec-8819-525400506ca8	oss-irms-180	3336	ONLINE	PRIMARY	8.0.27	XCommysql: <span style=color:#f92672>[</span>Warning<span style=color:#f92672>]</span> Using a password on the command line interface can be insecure.
</code></pre></div><p><strong>至此，您已经完成 MySQLInnoDB 集群的安装</strong></p>
<h4 id=安装完成后删除安装文件>安装完成后删除安装文件</h4>
<p>删除过程中产生的临时脚本文件（<strong>因为里面包含 root 密码等敏感信息</strong>）</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;rm -rf /data01/mysql/script/*&#39;</span>
</code></pre></div><p>(<strong>可选</strong>)删除安装包文件（删除后可以释放出约1.3GB的磁盘空间）</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;rm /opt/*.tar.*&#39;</span>
</code></pre></div><h2 id=常用运维命令>常用运维命令</h2>
<p>启动 MySQL</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;~/mysql.server start&#39;</span>
10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
Starting MySQL........ SUCCESS!

10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
Starting MySQL........ SUCCESS!

10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
Starting MySQL........... SUCCESS!
</code></pre></div><p>停止 MySQL</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;~/mysql.server stop&#39;</span>
10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
Shutting down MySQL... SUCCESS!

10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
Shutting down MySQL... SUCCESS!

10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
Shutting down MySQL...... SUCCESS!
</code></pre></div><p>检查 MySQL 服务状态</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;~/mysql.server status&#39;</span>
10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
 SUCCESS! MySQL running <span style=color:#f92672>(</span>25729<span style=color:#f92672>)</span>

10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
 SUCCESS! MySQL running <span style=color:#f92672>(</span>9462<span style=color:#f92672>)</span>

10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
 SUCCESS! MySQL running <span style=color:#f92672>(</span>28934<span style=color:#f92672>)</span>
</code></pre></div><p>检查 MySQL 集群状态</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible 10.1.207.180 -m shell -a <span style=color:#e6db74>&#39;source ~/.bash_profile &amp;&amp; mysqlsh --password=&#34;CoolbeevipWowo&#34; root@10.1.207.180:3336 -- cluster status&#39;</span>
10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;clusterName&#34;</span>: <span style=color:#e6db74>&#34;mycluster&#34;</span>,
    <span style=color:#e6db74>&#34;defaultReplicaSet&#34;</span>: <span style=color:#f92672>{</span>
        <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;default&#34;</span>,
        <span style=color:#e6db74>&#34;primary&#34;</span>: <span style=color:#e6db74>&#34;oss-irms-180:3336&#34;</span>,
        <span style=color:#e6db74>&#34;ssl&#34;</span>: <span style=color:#e6db74>&#34;REQUIRED&#34;</span>,
        <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;OK&#34;</span>,
        <span style=color:#e6db74>&#34;statusText&#34;</span>: <span style=color:#e6db74>&#34;Cluster is ONLINE and can tolerate up to ONE failure.&#34;</span>,
        <span style=color:#e6db74>&#34;topology&#34;</span>: <span style=color:#f92672>{</span>
            <span style=color:#e6db74>&#34;oss-irms-180:3336&#34;</span>: <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;oss-irms-180:3336&#34;</span>,
                <span style=color:#e6db74>&#34;memberRole&#34;</span>: <span style=color:#e6db74>&#34;PRIMARY&#34;</span>,
                <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;R/W&#34;</span>,
                <span style=color:#e6db74>&#34;readReplicas&#34;</span>: <span style=color:#f92672>{}</span>,
                <span style=color:#e6db74>&#34;replicationLag&#34;</span>: null,
                <span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;HA&#34;</span>,
                <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;ONLINE&#34;</span>,
                <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;8.0.27&#34;</span>
            <span style=color:#f92672>}</span>,
            <span style=color:#e6db74>&#34;oss-irms-181:3336&#34;</span>: <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;oss-irms-181:3336&#34;</span>,
                <span style=color:#e6db74>&#34;memberRole&#34;</span>: <span style=color:#e6db74>&#34;SECONDARY&#34;</span>,
                <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;R/O&#34;</span>,
                <span style=color:#e6db74>&#34;readReplicas&#34;</span>: <span style=color:#f92672>{}</span>,
                <span style=color:#e6db74>&#34;replicationLag&#34;</span>: null,
                <span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;HA&#34;</span>,
                <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;ONLINE&#34;</span>,
                <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;8.0.27&#34;</span>
            <span style=color:#f92672>}</span>,
            <span style=color:#e6db74>&#34;oss-irms-182:3336&#34;</span>: <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;oss-irms-182:3336&#34;</span>,
                <span style=color:#e6db74>&#34;memberRole&#34;</span>: <span style=color:#e6db74>&#34;SECONDARY&#34;</span>,
                <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;R/O&#34;</span>,
                <span style=color:#e6db74>&#34;readReplicas&#34;</span>: <span style=color:#f92672>{}</span>,
                <span style=color:#e6db74>&#34;replicationLag&#34;</span>: null,
                <span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;HA&#34;</span>,
                <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;ONLINE&#34;</span>,
                <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;8.0.27&#34;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>,
        <span style=color:#e6db74>&#34;topologyMode&#34;</span>: <span style=color:#e6db74>&#34;Single-Primary&#34;</span>
    <span style=color:#f92672>}</span>,
    <span style=color:#e6db74>&#34;groupInformationSourceMember&#34;</span>: <span style=color:#e6db74>&#34;oss-irms-180:3336&#34;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>启动 MySQL Router</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;~/mysql_router_start.sh&#39;</span>
10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
PID <span style=color:#ae81ff>26307</span> written to <span style=color:#e6db74>&#39;/data01/mysql/router/mycluster/mysqlrouter.pid&#39;</span>
logging facility initialized, switching logging to loggers specified in configuration

10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
PID <span style=color:#ae81ff>8813</span> written to <span style=color:#e6db74>&#39;/data01/mysql/router/mycluster/mysqlrouter.pid&#39;</span>
logging facility initialized, switching logging to loggers specified in configuration

10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
PID <span style=color:#ae81ff>1158</span> written to <span style=color:#e6db74>&#39;/data01/mysql/router/mycluster/mysqlrouter.pid&#39;</span>
logging facility initialized, switching logging to loggers specified in configuration
</code></pre></div><p>停止 MySQL Router</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;~/mysql_router_stop.sh&#39;</span>
10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;


10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;


10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</code></pre></div><p>检查 MySQL Router 进程</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;ps -ef | grep mysql-router&#39;</span>
10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
mysql     <span style=color:#ae81ff>8813</span>     <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>1</span> 18:00 ?        00:00:01 /opt/mysql/mysql-router-8.0.27-linux-glibc2.12-x86_64/bin/mysqlrouter -c /data01/mysql/router/mycluster/mysqlrouter.conf
mysql     <span style=color:#ae81ff>9154</span>  <span style=color:#ae81ff>9153</span>  <span style=color:#ae81ff>9</span> 18:02 pts/1    00:00:00 /bin/sh -c ps -ef | grep mysql-router
mysql     <span style=color:#ae81ff>9158</span>  <span style=color:#ae81ff>9154</span>  <span style=color:#ae81ff>0</span> 18:02 pts/1    00:00:00 grep mysql-router

10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
mysql    <span style=color:#ae81ff>26307</span>     <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>1</span> 17:57 ?        00:00:01 /opt/mysql/mysql-router-8.0.27-linux-glibc2.12-x86_64/bin/mysqlrouter -c /data01/mysql/router/mycluster/mysqlrouter.conf
mysql    <span style=color:#ae81ff>26633</span> <span style=color:#ae81ff>26632</span>  <span style=color:#ae81ff>0</span> 17:58 pts/3    00:00:00 /bin/sh -c ps -ef | grep mysql-router
mysql    <span style=color:#ae81ff>26635</span> <span style=color:#ae81ff>26633</span>  <span style=color:#ae81ff>0</span> 17:58 pts/3    00:00:00 grep mysql-router

10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
mysql     <span style=color:#ae81ff>1158</span>     <span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>2</span> 17:56 ?        00:00:01 /opt/mysql/mysql-router-8.0.27-linux-glibc2.12-x86_64/bin/mysqlrouter -c /data01/mysql/router/mycluster/mysqlrouter.conf
mysql     <span style=color:#ae81ff>1420</span>  <span style=color:#ae81ff>1419</span>  <span style=color:#ae81ff>0</span> 17:57 pts/2    00:00:00 /bin/sh -c ps -ef | grep mysql-router
mysql     <span style=color:#ae81ff>1423</span>  <span style=color:#ae81ff>1420</span>  <span style=color:#ae81ff>0</span> 17:57 pts/2    00:00:00 grep mysql-router
</code></pre></div><p>使用 MySQL Router 连接到数据库并查看数据库变量</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;source ~/.bash_profile &amp;&amp; mysql -h 10.1.207.180 -P 36446 -uroot -pCoolbeevipWowo mysql -e &#34;show variables like \&#34;%max_connections%\&#34;;&#34;&#39;</span>
10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
Variable_name	Value
max_connections	<span style=color:#ae81ff>1000</span>
mysqlx_max_connections	100mysql: <span style=color:#f92672>[</span>Warning<span style=color:#f92672>]</span> Using a password on the command line interface can be insecure.

10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
Variable_name	Value
max_connections	<span style=color:#ae81ff>1000</span>
mysqlx_max_connections	100mysql: <span style=color:#f92672>[</span>Warning<span style=color:#f92672>]</span> Using a password on the command line interface can be insecure.

10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
Variable_name	Value
max_connections	<span style=color:#ae81ff>1000</span>
mysqlx_max_connections	100mysql: <span style=color:#f92672>[</span>Warning<span style=color:#f92672>]</span> Using a password on the command line interface can be insecure.
</code></pre></div><h2 id=q--a>Q & A</h2>
<h4 id=执行-main-mysqlyml-时-taskinitialize-mysql-失败>执行 main-mysql.yml 时 TASK[initialize mysql] 失败</h4>
<p>Q: 查看 <code>/data01/mysql/logs/mysqld.err</code> 文件中提示 <code>Resource temporarily unavailable</code></p>
<p>A: 请检查服务器内存是否够用</p>
<h4 id=如何彻底删除-mysql-innodb-集群>如何彻底删除 MySQL InnoDB 集群</h4>
<p>Q: 如何彻底删除 MySQL InnoDB 集群</p>
<p>A: <code>~/mysql_uninstall.sh</code> 脚本将停止 MySQL server 和 MySQL router，删除程序文件和所有数据文件</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash-5.0# ansible all -m shell -a <span style=color:#e6db74>&#39;~/mysql_uninstall.sh&#39;</span>
10.1.207.180 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;


10.1.207.182 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;


10.1.207.181 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</code></pre></div></div>
<div class=post-footer>
<div class=info>
<span class=separator><a class=category href=/categories/ansible/>ansible</a></span>
<span class=separator><a class=tag href=/tags/ansible/>ansible</a><a class=tag href=/tags/mysql/>mysql</a></span>
</div>
</div>
</div>
</div>
</div>
</div>
<script type=text/javascript src=/js/medium-zoom.min.2d6fd0be87fa98f0c9b4dc2536b312bbca48757f584f6ea1f394abc9bcc38fbc.js integrity="sha256-LW/Qvof6mPDJtNwlNrMSu8pIdX9YT26h85SrybzDj7w=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css integrity=sha384-t5CR+zwDAROtph0PXGte6ia8heboACF9R5l/DiY+WZ3P2lxNgvJkQk5n7GPvLMYw crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js integrity=sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8+w2LAIftJEULZABrF9PPFv+tVkH crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js integrity=sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB+w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v crossorigin=anonymous onload=renderMathInElement(document.body)></script></body>
</html>