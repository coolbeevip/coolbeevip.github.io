<!doctype html><html lang=en data-theme><head><title>Lei Zhang</title><meta charset=utf-8><meta name=generator content="Hugo 0.82.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="This is my knowledge base. I document things here"><link rel=stylesheet href=/css/style.min.7cf3c5090ac13256a5fa5531e5649cfe5a2ba7de88dca14ce0b6e253409a3511.css integrity="sha256-fPPFCQrBMlal+lUx5WSc/lorp96I3KFM4LbiU0CaNRE=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS+yuWSR4=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/custom.min.cd7936c50d56f98d62c7547a00bf2e7e991fef59134e336e0810382876374277.css integrity="sha256-zXk2xQ1W+Y1ix1R6AL8ufpkf71kTTjNuCBA4KHY3Qnc=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=/><link rel=alternate type=application/rss+xml href=/index.xml title><script type=text/javascript src=/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="This is my knowledge base. I document things here"></head><body><div class="sidebar animated fadeInDown"><div class=logo-title><div class=title><img src=/images/profile.jpg alt="profile picture"><h3 title><a href=/>I'm Lei Zhang</a></h3><div class=description><p>This is my knowledge base. I document things here</p></div></div></div><ul class=social-links><li><a href=https://github.com/coolbeevip/ rel=me aria-label=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li><a href=mailto:zhanglei@apache.org rel=me aria-label=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li></ul><div class=footer><div class=by_farbox>&copy; Lei Zhang 2021</div></div></div><div class=main><div class="page-top animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><ul class=nav id=navMenu><li><a class=current href=/ title>Home</a></li><li><a href=/about/ title>About</a></li></ul></div><div class=autopagerize_page_element><div class=content><div class="post animated fadeInDown"></div><div class="post animated fadeInDown"><div class=post-title><h3><a href=/posts/docker-pulling-pushing/>Docker Pulling Pushing Batch Shell Script</a></h3></div><div class=post-content><div class=p_part><p>从源镜像仓库批量拉取镜像，并将这些镜像推送到目标镜像仓库的批量脚本
#!/bin/bash ################################################# # 使用方式 # 从源仓库拉取镜像到本机 # sh docker-images-pulling-pushing.sh pull # # 将本机镜像推送到目的仓库 # sh docker-images-pulling-pushing.sh push # # 清理本机的镜像 # sh docker-images-pulling-pushing.sh clean ################################################# # 源仓库地址 DOCKER_REPO_FROM= # 目标仓库地址 DOCKER_REPO_TO=192.168.2.2:8888/ DOCKER_REPO_TO_USER=test DOCKER_REPO_TO_PASS=Test123456 # 镜像定义 DOCKER_IMAGES=() DOCKER_IMAGES+=(postgres:9.6) DOCKER_IMAGES+=(elasticsearch:6.6.2) DOCKER_IMAGES+=(coolbeevip/servicecomb-pack) # 从源仓库地址拉取镜像到本机仓库 function pull(){ echo "Pull images from $DOCKER_REPO_FROM" for image in ${DOCKER_IMAGES[@]}; do docker pull $DOCKER_REPO_FROM$image done } # 本机镜像推送到目的仓库 function push(){ docker login http://$DOCKER_REPO_TO -u $DOCKER_REPO_TO_USER -p $DOCKER_REPO_TO_PASS echo "Push $DOCKER_REPO_FROMto $DOCKER_REPO_TO" for image in ${DOCKER_IMAGES[@]}; do docker image tag $DOCKER_REPO_FROM$image $DOCKER_REPO_TO$image docker push $DOCKER_REPO_TO$image done } # 清理本机拉取后的镜像 function clean(){ echo "Remove images" docker rmi -f $(docker images | grep $DOCKER_REPO_FROM | awk '{print $3}') docker rmi -f $(docker images | grep $DOCKER_REPO_TO | awk '{print $3}') } case "${@: -1}" in pull ) pull ;; clean ) clean ;; push ) push ;; esac</p></div></div><div class=post-footer><div class=meta><div class=info><em class="fas fa-calendar-day"></em><span class=date>Mon, Apr 19, 2021</span>
<span class=separator><a class=category href=/categories/docker/>docker</a><a class=category href=/categories/shell/>shell</a></span></div></div></div></div><div class="post animated fadeInDown"><div class=post-title><h3><a href=/posts/best-practices-for-structuring-maven-projects-and-modules/>Maven项目和模块的最佳实践</a></h3></div><div class=post-content><div class=p_part><p>本文整理构建Maven项目和模块的最佳实践的关键事项，其中包含依赖、版本、属性、模块划分等关键因素，推荐使用 Maven 3.6.3 及以上版本。 为了便于理解，我们假设有一个 API 网关项目，这个网关项目包含服务端、客户端、通知服务端支持插件。
目标 通过多模块方式组织项目 管理项目版本、依赖，属性 规划模块依赖关系 主项目 POM 每个项目都应该在项目根目录下有一个主 POM 文件，并通过主 POM 文件管理下级子模块。在主 POM 中至少会使用一下标签
properties: 定义字符集编码、JDK 版本、插件版本; modules: 下级子模块; pluginRepositories: 插件仓库地址（非必须，主要解决国内访问慢的问题）; repositories: 定义 Maven 私服地址; distributionManagement: 定义发布用 Maven 私服地址 pluginManagement: 定义管理类插件版本 例如：
&lt;?xml version="1.0" encoding="UTF-8"?> &lt;build xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"> &lt;modelVersion>4.0.0&lt;/modelVersion> &lt;groupId>com.coolbeevip.apigateway&lt;/groupId> &lt;artifactId>apigateway-parent&lt;/artifactId> &lt;version>1.0.0-SNAPSHOT&lt;/version> &lt;packaging>pom&lt;/packaging> &lt;properties> &lt;!-- project --> &lt;project.build.sourceEncoding>UTF-8&lt;/project.build.sourceEncoding> &lt;project.reporting.outputEncoding>UTF-8&lt;/project.reporting.outputEncoding> &lt;maven.compiler.encoding>UTF-8&lt;/maven.compiler.encoding> &lt;maven.compiler.source>8&lt;/maven.compiler.source> &lt;maven.compiler.target>8&lt;/maven.compiler.target> &lt;!-- plugins version --> &lt;maven-compiler-plugin.version>3.1&lt;/maven-compiler-plugin.version> &lt;jacoco-maven-plugin.version>0.8.6&lt;/jacoco-maven-plugin.version> &lt;docker-maven-plugin.</p><a href=/posts/best-practices-for-structuring-maven-projects-and-modules/ class=read_more>Read more</a></div></div><div class=post-footer><div class=meta><div class=info><em class="fas fa-calendar-day"></em><span class=date>Sat, May 2, 2020</span>
<span class=separator><a class=category href=/categories/maven/>maven</a><a class=category href=/categories/java/>java</a><a class=category href=/categories/project/>project</a></span></div></div></div></div><div class="post animated fadeInDown"><div class=post-title><h3><a href=/posts/git-command-rebase-upstream/>Git Fork 后同步上游分支</a></h3></div><div class=post-content><div class=p_part><p>当你 fork 一个仓库后，可以时用此方法使你 fork 后的仓库 master 分支保持和上游 master 分支的同步
使用 rebase 命令同步上游 master 分支到你本地的 master 分支，并推送到你 fork 后的仓库
git fetch upstream git checkout master git rebase upstream/master git push -f origin master 或者你确定放弃你本地所有的修改，则可以简单的重置为上游版本
git fetch upstream git checkout master git reset --hard upstream/master git push -f origin master 如果你也想同步 master 分支的修改到你的功能分支
git checkout &lt;分支名> git rebase master git push -f origin &lt;分支名></p></div></div><div class=post-footer><div class=meta><div class=info><em class="fas fa-calendar-day"></em><span class=date>Mon, Apr 6, 2020</span>
<span class=separator><a class=category href=/categories/git/>git</a></span></div></div></div></div><div class="post animated fadeInDown"><div class=post-title><h3><a href=/posts/git-command-commit-squash/>Git Squash Commits</a></h3></div><div class=post-content><div class=p_part><p>压缩合并 Commits，将多个 commit 整理合并的方法，这样可以使提交记录更加清晰
查看提交记录，选择你要合并的范围 git log commit 6d757f70af289b5a90d00bd5e4b93d892d64a258 (HEAD -> SCB-1669) Author: Lei Zhang &lt;zhanglei@apache.org> Date: Thu Dec 19 13:53:26 2019 +0800 SCB-1669 Fixed reverse compensation sort bug in FSM commit 37e0c5d99d0e6dae188cbd78f543ba69433b928f (origin/SCB-1669) Author: Lei Zhang &lt;zhanglei@apache.org> Date: Thu Dec 19 02:00:20 2019 +0800 SCB-1669 Fixed Reverse compensation sort bug in FSM commit b4ea8717a86d1eba1956d21727d05c466ff6d8a2 (upstream/master, origin/master, origin/HEAD, master) Author: Lei Zhang &lt;zhanglei@apache.org> Date: Tue Dec 10 16:25:48 2019 +0800 SCB-1658 Improve encapsulation on txEntityMap of SagaData 可以看到最后两次提交，都是为了修复 SCB-1669 这个问题，此时我想合并最后两次提交 6d757f70af289b5a90d00bd5e4b93d892d64a258 和 37e0c5d99d0e6dae188cbd78f543ba69433b928f</p><a href=/posts/git-command-commit-squash/ class=read_more>Read more</a></div></div><div class=post-footer><div class=meta><div class=info><em class="fas fa-calendar-day"></em><span class=date>Mon, Apr 6, 2020</span>
<span class=separator><a class=category href=/categories/git/>git</a></span></div></div></div></div><div class="post animated fadeInDown"><div class=post-title><h3><a href=/posts/git-command-commit-stash/>Git Stash</a></h3></div><div class=post-content><div class=p_part><p>你在当前分支上开发代码，此时不想 commit，但是又想切换到其他分支完成其他的工作，此时可以用 stash
在当前分支执行 stash 将当前分支未提交的代码隐藏起来 $ git stash Saved working directory and index state WIP on SCB-1577: 2554be3d SCB-1593 Add notice for Boringssl support ciphers (base) bogon:servicecomb-pack zhanglei$ 此时你可以看到已经存储到一个id为 2554be3d 里了，这时你可以用 git status 查看已经没有要提交的内容了
git status On branch SCB-1577 nothing to commit, working tree clean (base) bogon:servicecomb-pack zhanglei$ 这时你就可以切换到其他分支开始新的工作 (base) bogon:servicecomb-pack zhanglei$ git checkout master Switched to branch 'master' Your branch is up to date with 'origin/master'.</p><a href=/posts/git-command-commit-stash/ class=read_more>Read more</a></div></div><div class=post-footer><div class=meta><div class=info><em class="fas fa-calendar-day"></em><span class=date>Mon, Apr 6, 2020</span>
<span class=separator><a class=category href=/categories/git/>git</a></span></div></div></div></div><div class="post animated fadeInDown"><div class=post-title><h3><a href=/posts/linux-commands-check/>常用 Linux 检测命令</a></h3></div><div class=post-content><div class=p_part><p>IO 磁盘IO测试
[root@localhost ~]# dd if=/dev/zero of=./a.dat bs=8K count=1M conv=fdatasync 记录了8192+0 的读入 记录了8192+0 的写出 8589934592字节(8.6 GB)已复制，14.8606 秒，578 MB/秒 [root@localhost ~]# dd if=./a.dat of=/dev/null bs=1M count=8k iflag=direct 记录了8192+0 的读入 记录了8192+0 的写出 8589934592字节(8.6 GB)已复制，14.2462 秒，603 MB/秒</p></div></div><div class=post-footer><div class=meta><div class=info><em class="fas fa-calendar-day"></em><span class=date>Mon, May 6, 2019</span>
<span class=separator><a class=category href=/categories/linux/>linux</a></span></div></div></div></div><div class="post animated fadeInDown"><div class=post-title><h3><a href=/posts/git-commands/>常用 Git 命令</a></h3></div><div class=post-content><div class=p_part><p>常用 Git 命令
Branch 创建分支
git checkout -b &lt;分支名> 推送分支
git push origin &lt;分支名> 修改分支名
git branch -m &lt;旧分支名> &lt;新分支名> 删除本地分支
git branch -D &lt;分支名> 删除远程分支
git push origin --delete &lt;分支名> 拉取远程分支
git fetch origin &lt;分支名> 拉取远程分支并切换
git checkout -b &lt;分支名> origin/&lt;分支名> 当前分支会退到指定版本
git reset --hard &lt;版本号的sha1> Tag 创建本地 Tag
git tag -a &lt;标签名> -m "my tag" 删除本地 Tag
git tag -d &lt;标签名> 删除远程 Tag
git push origin :refs/tags/&lt;标签名> 推送本地所有 Tag 到远程</p><a href=/posts/git-commands/ class=read_more>Read more</a></div></div><div class=post-footer><div class=meta><div class=info><em class="fas fa-calendar-day"></em><span class=date>Sat, Apr 6, 2019</span>
<span class=separator><a class=category href=/categories/git/>git</a></span></div></div></div></div><div class="post animated fadeInDown"><div class=post-title><h3><a href=/posts/docker-commands/>常用 Docker 命令</a></h3></div><div class=post-content><div class=p_part><p>常用 Docker 命令记录
镜像 删除所有镜像 docker rmi -f $(docker images | awk '{print $3}') 删除所有 dangling 镜像 docker rmi -f $(docker images -a | grep "&lt;none>" | awk '{print $3}') 导出镜像 docker save -o postgres_9.6.tar postgres:9.6 导入镜像 docker load -i postgres_9.6.tar 容器 删除所有 Exited 容器 docker rm $(docker ps -a | grep Exited | awk '{print $1}') 停止并删除所有容器 docker stop $(docker ps | awk '{print $1}') docker rm -f $(docker ps -a | awk '{print $1}') 停止 dead 容器 删除实例时提示 device or resource busy</p><a href=/posts/docker-commands/ class=read_more>Read more</a></div></div><div class=post-footer><div class=meta><div class=info><em class="fas fa-calendar-day"></em><span class=date>Wed, Feb 6, 2019</span>
<span class=separator><a class=category href=/categories/docker/>docker</a></span></div></div></div></div><div class="post animated fadeInDown"><div class=post-title><h3><a href=/posts/flyway-hung-on-mysql-router-mgr/>Flyway hung on the MySQL Router + MGR</a></h3></div><div class=post-content><div class=p_part><p>Flyway 连接 MySQL Router 后启动卡在 GET_LOCK 语句
现象 MySQL MGR + Router 部署高可用集群 Flyway 客户端使用 jdbc:mysql:loadbalance 连接 初始化 Schema History 表、或者执行多个 SQL 脚本时 当满足以上条件时，Flyway 会卡在初始化阶段，经过分析发现停顿在执行 GET_LOCK 语句时
原因 Flyway 默认在执行 DDL 脚本时不启用事务，在初始化时 Flyway 会先执行 GET_LOCK 锁定数据库，然后再执行 DDL 脚本。当使用 jdbc:mysql:loadbalance 连接时，会随机选择一个数据源，如果执行 GET_LOCK 和 执行 DDL 不是一个数据源，就会导致执行等待锁释放
解决办法 在启动时设置 group=true 参数，这样 Flyway 在初始化时就会启用事务，确保一个事务内的 DDL 都在一个数据源执行
ISSUE-3154
public class FlywayTestManual { String url="jdbc:mysql:loadbalance://192.168.51.206:3810,192.168.51.207:3810/nc_notifier?roundRobinLoadBalance=false&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=GMT%2B8&allowMultiQueries=true&allowPublicKeyRetrieval=true"; String user="user"; String password="pass"; @Test public void test(){ Flyway flyway = Flyway.</p><a href=/posts/flyway-hung-on-mysql-router-mgr/ class=read_more>Read more</a></div></div><div class=post-footer><div class=meta><div class=info><em class="fas fa-calendar-day"></em><span class=date>Thu, Nov 29, 2018</span>
<span class=separator><a class=category href=/categories/java/>java</a><a class=category href=/categories/flyway/>flyway</a><a class=category href=/categories/mysql/>mysql</a></span></div></div></div></div><div class="post animated fadeInDown"><div class=post-title><h3><a href=/posts/java-flyway-support-oracle/>Flyway Support Oracle</a></h3></div><div class=post-content><div class=p_part><p>记录在使用 Flyway 管理 Oracle 数据库脚本时遇到的一些问题，Flyway 5.2.1 - 7.7.3 都存在此问题。
1. Flyway not support Oracle 11g 异常信息
Caused by: org.flywaydb.core.internal.license.FlywayEditionUpgradeRequiredException: Flyway Enterprise Edition or Oracle upgrade required: Oracle 11.2 is no longer supported by Flyway Community Edition, but still supported by Flyway Enterprise Edition. at org.flywaydb.core.internal.database.base.Database.ensureDatabaseNotOlderThanOtherwiseRecommendUpgradeToFlywayEdition(Database.java:173) at org.flywaydb.core.internal.database.oracle.OracleDatabase.ensureSupported(OracleDatabase.java:91) at org.flywaydb.core.Flyway.execute(Flyway.java:514) at org.flywaydb.core.Flyway.migrate(Flyway.java:159) at org.springframework.boot.autoconfigure.flyway.FlywayMigrationInitializer.afterPropertiesSet(FlywayMigrationInitializer.java:65) at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1855) at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1792) ... 19 common frames omitted 修改 Flyway 5.2.4 OracleDatabase.java 社区版本做了版本号限制 修改 Flyway 6.</p><a href=/posts/java-flyway-support-oracle/ class=read_more>Read more</a></div></div><div class=post-footer><div class=meta><div class=info><em class="fas fa-calendar-day"></em><span class=date>Thu, Nov 29, 2018</span>
<span class=separator><a class=category href=/categories/java/>java</a><a class=category href=/categories/flyway/>flyway</a><a class=category href=/categories/oracle/>oracle</a></span></div></div></div></div><div class=pagination><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class="page-item disabled"><a class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class="page-item active"><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a href=/page/2/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/2/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div></div></div><script type=text/javascript src=/js/medium-zoom.min.2d6fd0be87fa98f0c9b4dc2536b312bbca48757f584f6ea1f394abc9bcc38fbc.js integrity="sha256-LW/Qvof6mPDJtNwlNrMSu8pIdX9YT26h85SrybzDj7w=" crossorigin=anonymous></script></body></html>